<!doctype html>
<html>

<head>
  <title>Spotify Lyrics</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
    integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  
  <div class="container">
    <div id="login">
      <h1>Please login with your Spotify account to continue</h1>
      <a href="/login" class="btn btn-primary spotify-login">
        <i class="fab fa-spotify"></i> Log in with Spotify
      </a>
    </div>
    <div id="loggedin">
      <div class="row">
        <div class="col-sm-6" id="current-song"></div>
        <div class="col-sm-6" id="lyrics"></div>
      </div>
    </div>
  </div>

  <script id="current-song-template" type="text/x-handlebars-template">
    <h1>Now playing <button onclick=loggedInView() class="btn btn-default"><i class="fas fa-sync"></i></button></h1><br>
    <img class="media-object" width="300" src="{{item.album.images.0.url}}"/><br>
    <dl>
      <dt>Song name</dt><dd class="clearfix">{{item.name}}</dd>
      <dt>Artist</dt><dd class="clearfix">{{item.artists.0.name}}</dd>
    </dl>
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/postscribe/2.0.8/postscribe.min.js"></script>

  <script>

    /**
    * Obtains parameters from the hash of the URL
    * @return Object
    */
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while (e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }

    var currentSongSource = document.getElementById('current-song-template').innerHTML;
    var currentSongTemplate = Handlebars.compile(currentSongSource);
    var currentSongPlaceholder = document.getElementById('current-song');

    var params = getHashParams();

    var access_token = params.access_token;
    var refresh_token = params.refresh_token;
    var error = params.error;

    if (error) {
      alert('There was an error during the authentication');
    } else {
      if (access_token) {

        loggedInView();

      } else {

        // render initial screen
        $('#login').show();
        $('#loggedin').hide();

      }
    }

    function loggedInView() {

      $('#login').hide();
      $('#loggedin').show();

      console.log("Access token:", access_token, "Refresh token:", refresh_token)

      $.ajax({
        url: 'https://api.spotify.com/v1/me/player',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {

          if (response && response.is_playing) {
            currentSongPlaceholder.innerHTML = currentSongTemplate(response);
            setLyrics(response);
          } else {
            currentSongPlaceholder.innerHTML = 
              '<h1>Spotify is currently not playing a song <button onclick=loggedInView() class="btn btn-default"><i class="fas fa-sync"></i></button></h1>'
          }
        }
      });
    }

    function setLyrics(spotifyPlayer) {

      var lyricsDiv = document.getElementById("lyrics");
      lyricsDiv.innerHTML = 'Loading lyrics...';

      var search = spotifyPlayer.item.name + " - " + spotifyPlayer.item.artists[0].name;

      $.ajax({
        url: 'get_lyrics_embed',
        data: { q: search },
        success: function (response) {
          if (lyricsDiv.hasChildNodes())
            lyricsDiv.innerHTML = "";
          postscribe('#lyrics', response);
        }
      });
    }
  </script>

</body>

</html>